#!/usr/bin/env python

import socket
import struct
import sys

from time import sleep
from tools import parce_trace_data
from tracetools.tracetools import trace

class ATM:
  def __init__(self, host, port):
    """
    """
    self.host = host
    self.port = port

    try:
        self.sock = None
        for res in socket.getaddrinfo(self.host, self.port, socket.AF_UNSPEC, socket.SOCK_STREAM):
            af, socktype, proto, canonname, sa = res
            self.sock = socket.socket(af, socktype, proto)
            self.sock.connect(sa)
    except OSError as msg:
        print('Error connecting to {}:{} - {}'.format(self.host, self.port, msg))
        sys.exit()

    print('Connected to {}:{}'.format(self.host, self.port))


  def get_message_length(self, message):
    """
    """
    return b'\x00\x00'


  def send(self, data):
    """
    """
    data = struct.pack("!H", len(data)) + data
    self.sock.send(data)
    trace('>> {} bytes sent:'.format(len(data)), data)


  def recv(self):
    """
    """
    data = self.sock.recv(4096)    
    trace('<< {} bytes received: '.format(len(data)), data)
    return data


if __name__ == '__main__':
  atm = ATM('127.0.0.1', 11032)
  
  requests = [ 
  """13:51:42.580796 -| 31.31.1C.30.30.35.30.30.30.30.30.30.1C.1C.1C.31       11.005000000...1
  13:51:42.580806 -| 31.1C.3B.36.30.33.37.39.39.31.30.31.32.33.34.35       1.;6037991012345
  13:51:42.580815 -| 36.37.34.3D.32.30.30.33.31.30.31.31.32.39.35.37       674=200310112957
  13:51:42.580824 -| 34.30.37.3F.1C.1C.46.49.20.20.49.20.20.41.1C.30       407?..FI  I  A.0
  13:51:42.580833 -| 30.30.30.30.30.30.30.1C.31.3A.39.30.3F.3D.3F.30       0000000.1:90?=?0
  13:51:42.580842 -| 3F.34.32.30.35.34.34.36.1C.1C.1C.1C.32.35.37.31       ?4205446....2571
  13:51:42.580851 -| 36.31.30.30.30.30.30.30.30.30.30.30.30.30.30.30       6100000000000000
  13:51:42.580858 -| 30.30.30.30.30.30                                     000000 """,

  "wait_response",

  """13:51:44.442984 -| 31.31.1C.30.30.35.30.30.30.30.30.30.1C.1C.1C.31       11.005000000...1
  13:51:44.442992 -| 32.1C.1C.1C.1C.1C.1C.41.1C                            2......A.""",

  "wait_response",

  """13:51:44.898394 -| 32.32.1C.30.30.35.30.30.30.30.30.30.1C.1C.42          22.005000000..B""",

  "sleep",

  """13:51:45.008850 -| 31.31.1C.30.30.35.30.30.30.30.30.30.1C.1C.1C.31       11.005000000...1
  13:51:45.008861 -| 33.1C.3B.36.30.33.37.39.39.31.30.31.32.33.34.35       3.;6037991012345
  13:51:45.008877 -| 36.37.34.3D.32.30.30.33.31.30.31.31.32.39.35.37       674=200310112957
  13:51:45.008887 -| 34.30.37.3F.1C.1C.44.47.20.47.49.20.43.44.1C.30       407?..DG GI CD.0
  13:51:45.008896 -| 30.30.30.30.30.30.30.1C.31.3A.39.30.3F.3D.3F.30       0000000.1:90?=?0
  13:51:45.008905 -| 3F.34.32.30.35.34.34.36.1C.41.1C.1C.1C.32.35.37       ?4205446.A...257
  13:51:45.008914 -| 31.37.31.30.30.30.30.30.30.30.30.30.30.30.30.30       1710000000000000
  13:51:45.008921 -| 30.30.30.30.30.30.30                                  0000000 """,

  "wait_response",

  """13:51:46.942618 -| 31.31.1C.30.30.35.30.30.30.30.30.30.1C.1C.1C.31       11.005000000...1
  13:51:46.942625 -| 34.1C.1C.1C.1C.1C.1C.48.1C                            4......H.   """,

  "wait_response",

  """13:51:47.398972 -| 32.32.1C.30.30.35.30.30.30.30.30.30.1C.1C.42          22.005000000..B""",

  """13:51:54.395624 -| 31.31.1C.30.30.35.30.30.30.30.30.30.1C.1C.1C.31       11.005000000...1
  13:51:54.395633 -| 35.1C.3B.36.30.33.37.39.39.31.30.31.32.33.34.35       5.;6037991012345
  13:51:54.395642 -| 36.37.34.3D.32.30.30.33.31.30.31.31.32.39.35.37       674=200310112957
  13:51:54.395651 -| 34.30.37.3F.1C.1C.44.46.20.46.49.20.41.44.1C.30       407?..DF FI AD.0
  13:51:54.395660 -| 30.30.30.30.30.30.30.1C.31.3A.39.30.3F.3D.3F.30       0000000.1:90?=?0
  13:51:54.395669 -| 3F.34.32.30.35.34.34.36.1C.48.1C.36.32.35.31.31       ?4205446.H.62511
  13:51:54.395678 -| 36.1C.1C.32.35.37.31.38.31.30.30.30.30.30.30.30       6..2571810000000
  13:51:54.395686 -| 30.30.30.30.30.30.30.30.30.30.30.30.30                0000000000000 """,

  "wait_response",

  """13:51:44.898394 -| 32.32.1C.30.30.35.30.30.30.30.30.30.1C.1C.42          22.005000000..B""",

  "sleep",

  """13:52:03.238195 -| 31.31.1C.30.30.35.30.30.30.30.30.30.1C.1C.1C.31       11.005000000...1
  13:52:03.238204 -| 36.1C.3B.36.30.33.37.39.39.31.30.31.32.33.34.35       6.;6037991012345
  13:52:03.238213 -| 36.37.34.3D.32.30.30.33.31.30.31.31.32.39.35.37       674=200310112957
  13:52:03.238222 -| 34.30.37.3F.1C.1C.44.46.20.46.49.20.43.44.1C.30       407?..DF FI CD.0
  13:52:03.238267 -| 30.30.30.30.30.30.30.1C.31.3A.39.30.3F.3D.3F.30       0000000.1:90?=?0
  13:52:03.238277 -| 3F.34.32.30.35.34.34.36.1C.48.1C.38.36.30.31.30       ?4205446.H.86010
  13:52:03.238286 -| 34.1C.1C.32.35.37.31.38.31.30.30.30.30.30.30.30       4..2571810000000
  13:52:03.238294 -| 30.30.30.30.30.30.30.30.30.30.30.30.30                0000000000000   """,

  "wait_response",

  """13:52:06.926141 -| 31.31.1C.30.30.35.30.30.30.30.30.30.1C.1C.1C.31       11.005000000...1
  13:52:06.926149 -| 37.1C.1C.1C.1C.1C.1C.43.1C                            7......C.""",
  
  "wait_response",

  ]


  for item in requests:
    if item == "sleep":
      sleep(1)
    elif item == "wait_response":
      atm.recv()
    else:
      atm.send(parce_trace_data(item))

